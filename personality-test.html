<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>接客タイプ診断</title>
    
    <meta property="og:title" content="接客タイプ診断" />
    <meta property="og:description" content="あなたにピッタリな接客スタイルは？12の質問であなたの強みを診断します！" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://[あなたのサイトURL]/shindan.html" /> 
    <meta property="og:image" content="https://[あなたのサイトURL]/og-image.png" />
    <meta name="twitter:card" content="summary_large_image">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="/personality-test/manifest.json">
</head>
<body>

    <div id="shindan-app">

        <div id="start-screen">
            <h1>接客タイプ診断</h1>
            <p class="subtitle">What is Your Hospitality Style</p>
            <p class="description">
                あなたにピッタリな接客スタイルは？<br>
                12の質問であなたの強みを診断します！
            </p>
            <button id="start-btn" disabled>読み込み中...</button>
        </div>

        <form id="shindan-form">
            <div id="loading">診断データを読み込んでいます...</div>
            <button type="submit" id="submit-btn" style="display:none;">診断する</button>
        </form>

        <div id="result">
            <h2>あなたのタイプは... <span id="result-type"></span></h2>
            <h3 id="result-title"></h3>
            <img id="result-image" src="" alt="診断結果イラスト" style="display: none;">
            <div id="result-strength"></div>
            <p id="result-description"></p>
            <div id="result-breakdown"></div>
            <div id="share-buttons">
                <a href="#" id="share-x" class="share-btn" target="_blank">Xでシェア</a>
                <a href="#" id="share-line" class="share-btn" target="_blank">LINEでシェア</a>
            </div>
        </div>

    </div>

    <script>
        // --- グローバル変数 ---
        let questionData = []; 
        let resultData = {};   
        const axisDescriptions = {
            'L': { title: 'リード型 (L)', text: '会話の主導権を握り、積極的に場を盛り上げるのが得意なタイプです。' },
            'F': { title: 'フォロワー型 (F)', text: '聞き役に徹し、お客様のペースに合わせて心地よい空間を作るのが得意なタイプです。' },
            'C': { title: '恋人型 (C)', text: '「女性らしさ」や「色気」を武器に、お客様を異性としてドキドキさせるのが得意なタイプです。' },
            'P': { title: 'パートナー型 (P)', text: '「知性」や「人間的な面白さ」を武器に、お客様と対等な関係を築くのが得意なタイプです。' },
            'I': { title: '懐（ふところ）型 (I)', text: '「人懐っこさ」や「素の自分」を見せ、短時間でお客様の懐に飛び込むのが得意なタイプです。' },
            'O': { title: '領域（テリトリー）型 (O)', text: '「プロとしての距離感」を保ち、「憧れ」や「ミステリアスさ」を演出するのが得意なタイプです。' },
            'H': { title: 'ハンター型 (H)', text: '「瞬発力」で、イベントなど短期集中的に大きな結果を出すのが得意なタイプです。' },
            'Farmer_F': { title: 'ファーマー型 (F)', text: '「マメな連絡」や「継続力」で、お客様との関係をじっくり育てるのが得意なタイプです。' }
        };

        // --- 1. アプリの初期化処理 ---
        document.addEventListener('DOMContentLoaded', () => {
            // ★追加★ 画面要素を取得
            const startScreen = document.getElementById('start-screen');
            const shindanForm = document.getElementById('shindan-form');
            const resultScreen = document.getElementById('result');
            const startBtn = document.getElementById('start-btn');

            // ★追加★ 念のため、JSでも初期状態をセット
            startScreen.style.display = 'block';
            shindanForm.style.display = 'none';
            resultScreen.style.display = 'none';

            // CSVの読み込みと質問の生成を先に行う
            loadAllData(startBtn);

            // ★変更★ スタートボタンにクリックイベントを設定
            startBtn.addEventListener('click', () => {
                startScreen.style.display = 'none'; // スタート画面を非表示
                shindanForm.style.display = 'block'; // 診断フォームを表示
                // 画面の先頭にスクロール
                document.getElementById('shindan-app').scrollIntoView({ behavior: 'smooth' });
            });
        });

        // --- 2. 必要なCSVファイルをすべて読み込む ---
        async function loadAllData(startBtn) { // startBtnを引数で受け取る
            try {
                const [questions, results] = await Promise.all([
                    loadCSV('questions.csv'),
                    loadCSV('results.csv')
                ]);

                questionData = questions;
                results.forEach(row => {
                    if (row.type) {
                        resultData[row.type] = {
                            title: row.title,
                            description: row.description,
                            strength: row.strength
                        };
                    }
                });

                // 質問フォームをHTMLで生成する (まだ非表示)
                generateQuestionsHTML();

                // CSV読み込み完了後、スタートボタンを有効化
                startBtn.disabled = false;
                startBtn.textContent = '診断をはじめる';

            } catch (error) {
                console.error("CSVファイルの読み込みに失敗しました:", error);
                startBtn.textContent = "エラーが発生しました";
            }
        }

        // --- 3. CSVファイルを読み込む関数 ---
        function loadCSV(url) {
            return new Promise((resolve, reject) => {
                Papa.parse(url, {
                    download: true, header: true, skipEmptyLines: true, encoding: "UTF-8",
                    complete: (results) => resolve(results.data),
                    error: (err) => reject(err)
                });
            });
        }

        // --- 4. 5段階評価の質問フォームを動的に生成する ---
        function generateQuestionsHTML() {
            const form = document.getElementById('shindan-form');
            const loadingEl = form.querySelector('#loading'); // form内のloadingを取得
            const submitBtn = form.querySelector('#submit-btn');
            
            let htmlContent = '';
            let questionCount = 1;

            questionData.forEach(q => {
                htmlContent += `
                    <div class="question" data-axis="${q.axis}" data-id="${q.id}">
                        <p>Q${questionCount}. ${q.statement}</p>
                        <div class="likert-scale">
                            <label><input type="radio" name="${q.id}" value="1"> <span data-label="1"></span></label>
                            <label><input type="radio" name="${q.id}" value="2"> <span data-label="2"></span></label>
                            <label><input type="radio" name="${q.id}" value="3"> <span data-label="3"></span></label>
                            <label><input type="radio" name="${q.id}" value="4"> <span data-label="4"></span></label>
                            <label><input type="radio" name="${q.id}" value="5"> <span data-label="5"></span></label>
                        </div>
                        <div class="likert-labels">
                            <span>そう思わない</span>
                            <span>そう思う</span>
                        </div>
                    </div>
                `;
                questionCount++;
            });

            loadingEl.style.display = 'none';
            // ★変更★ 質問HTMLをloadingElの前に挿入
            loadingEl.insertAdjacentHTML('beforebegin', htmlContent);
            submitBtn.style.display = 'block';
        }

        // --- 5. 診断実行 (フォーム送信時の処理) ---
        document.getElementById('shindan-form').addEventListener('submit', function(event) {
            event.preventDefault(); 

            const formData = new FormData(event.target);
            const answers = Object.fromEntries(formData.entries());

            if (Object.keys(answers).length < questionData.length) {
                alert("すべての質問に回答してください。");
                return;
            }

            // 集計ロジック
            const scores = { 
                axis1: { A: 0, B: 0 }, axis2: { A: 0, B: 0 },
                axis3: { A: 0, B: 0 }, axis4: { A: 0, B: 0 }
            };
            questionData.forEach(q => {
                const answer = answers[q.id]; const axis = q.axis;
                switch (answer) {
                    case '5': scores[axis].A += 2; break;
                    case '4': scores[axis].A += 1; break;
                    case '3': break;
                    case '2': scores[axis].B += 1; break;
                    case '1': scores[axis].B += 2; break;
                }
            });

            // タイプの決定
            const type = [
                (scores.axis1.A > scores.axis1.B) ? 'L' : 'F',
                (scores.axis2.A > scores.axis2.B) ? 'C' : 'P',
                (scores.axis3.A > scores.axis3.B) ? 'I' : 'O',
                (scores.axis4.A > scores.axis4.B) ? 'H' : 'F'
            ].join('');

            // ★変更★ フォームを非表示にし、結果を表示
            document.getElementById('shindan-form').style.display = 'none';
            const resultEl = document.getElementById('result');
            resultEl.style.display = 'block';

            // 結果の表示
            const result = resultData[type] || resultData["DEFAULT"];
            resultEl.querySelector('#result-type').textContent = type;
            resultEl.querySelector('#result-title').textContent = result.title;
            resultEl.querySelector('#result-description').innerHTML = result.description.replace(/\n/g, '<br>');
            resultEl.querySelector('#result-strength').textContent = result.strength;

            // イラスト表示ロジック
            const resultImage = resultEl.querySelector('#result-image');
            if (result.title !== "診断不能タイプ") {
                resultImage.src = `images/${type}.png`;
                resultImage.alt = result.title;
                resultImage.style.display = 'block';
            } else {
                resultImage.style.display = 'none';
            }

            // 4軸の解説の動的生成
            const breakdownEl = resultEl.querySelector('#result-breakdown');
            breakdownEl.innerHTML = ''; // 既存の内容をクリア
            const typeChars = type.split('');
            const desc1 = axisDescriptions[typeChars[0]];
            const desc2 = axisDescriptions[typeChars[1]];
            const desc3 = axisDescriptions[typeChars[2]];
            const desc4_key = typeChars[3] === 'F' ? 'Farmer_F' : typeChars[3];
            const desc4 = axisDescriptions[desc4_key];

            [desc1, desc2, desc3, desc4].forEach(desc => {
                breakdownEl.innerHTML += `
                    <div class="breakdown-item">
                        <span>${desc.title.match(/[A-Z]/)[0]}</span>
                        <p><strong>${desc.title}</strong>${desc.text}</p>
                    </div>
                `;
            });

            // シェアロジック
            const shareUrl = window.location.href; 
            const hashTag = "接客タイプ診断"; 
            const shareText = `私の接客タイプは【${result.title}（${type}）】でした！\nあなたの強みは「${result.strength}」\nあなたも診断してみよう！\n#${hashTag}\n`;
            
            resultEl.querySelector('#share-x').href = `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(shareUrl)}`;
            resultEl.querySelector('#share-line').href = `https://line.me/R/msg/text/?${encodeURIComponent(shareText + shareUrl)}`;

            // 結果表示位置にスクロール
            resultEl.scrollIntoView({ behavior: 'smooth' });
        });
    </script>
    <script>
        // GitHub Pagesのパスに合わせて調整
        const REPO_PATH = '/personality-test/';

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // sw.js を登録します。scope でPWAが動作する範囲を指定します。
                navigator.serviceWorker.register(REPO_PATH + 'sw.js', { scope: REPO_PATH })
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
    </script>
</body>
</html>
