<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>得意な接客タイプ診断</title>
    
    <meta property="og:title" content="得意な接客タイプ診断" />
    <meta property="og:description" content="あなたにピッタリな接客スタイルは？12の質問であなたの強みを診断します！" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://[あなたのサイトURL]/shindan.html" /> 
    <meta property="og:image" content="https://[あなたのサイトURL]/og-image.png" /> <meta name="twitter:card" content="summary_large_image">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div id="shindan-app">
        <h1>得意な接客タイプ診断</h1>

        <form id="shindan-form">
            <div id="loading">診断データを読み込んでいます...</div>
            
            <button type="submit" id="submit-btn" style="display:none;">診断する</button>
        </form>

        <div id="result">
            <h2>あなたのタイプは... <span id="result-type"></span></h2>
            <h3 id="result-title"></h3>
            <p id="result-description"></p>
            <div id="share-buttons">
                <a href="#" id="share-x" class="share-btn" target="_blank">Xでシェア</a>
                <a href="#" id="share-line" class="share-btn" target="_blank">LINEでシェア</a>
            </div>
        </div>
    </div>

    <script>
        // --- グローバル変数 ---
        let questionData = []; 
        let resultData = {};   

        // --- 1. アプリの初期化処理 ---
        document.addEventListener('DOMContentLoaded', () => {
            loadAllData();
        });

        // --- 2. 必要なCSVファイルをすべて読み込む ---
        async function loadAllData() {
            try {
                const [questions, results] = await Promise.all([
                    loadCSV('questions.csv'),
                    loadCSV('results.csv')
                ]);

                questionData = questions;
                results.forEach(row => {
                    if (row.type) {
                        resultData[row.type] = {
                            title: row.title,
                            description: row.description
                        };
                    }
                });

                // HTMLの質問フォームを生成する
                generateQuestionsHTML();

            } catch (error) {
                console.error("CSVファイルの読み込みに失敗しました:", error);
                document.getElementById('loading').textContent = "エラー: 診断データを読み込めませんでした。";
            }
        }

        // --- 3. CSVファイルを読み込む関数 (変更なし) ---
        function loadCSV(url) {
            return new Promise((resolve, reject) => {
                Papa.parse(url, {
                    download: true, header: true, skipEmptyLines: true, encoding: "UTF-8",
                    complete: (results) => resolve(results.data),
                    error: (err) => reject(err)
                });
            });
        }

        // --- 4. ★変更★ 5段階評価の質問フォームを動的に生成する ---
        function generateQuestionsHTML() {
            const form = document.getElementById('shindan-form');
            const loadingEl = document.getElementById('loading');
            const submitBtn = document.getElementById('submit-btn');
            
            let htmlContent = '';
            let questionCount = 1;

            questionData.forEach(q => {
                htmlContent += `
                    <div class="question" data-axis="${q.axis}" data-id="${q.id}">
                        <p>Q${questionCount}. ${q.statement}</p>
                        <div class="likert-scale">
                            <label><input type="radio" name="${q.id}" value="1"> <span data-label="1"></span></label>
                            <label><input type="radio" name="${q.id}" value="2"> <span data-label="2"></span></label>
                            <label><input type="radio" name="${q.id}" value="3"> <span data-label="3"></span></label>
                            <label><input type="radio" name="${q.id}" value="4"> <span data-label="4"></span></label>
                            <label><input type="radio" name="${q.id}" value="5"> <span data-label="5"></span></label>
                        </div>
                        <div class="likert-labels">
                            <span>強くそう思わない</span>
                            <span>どちらでもない</span>
                            <span>強くそう思う</span>
                        </div>
                    </div>
                `;
                questionCount++;
            });

            loadingEl.style.display = 'none';
            form.innerHTML = htmlContent; 
            form.appendChild(submitBtn);  
            submitBtn.style.display = 'block';
        }

        // --- 5. ★変更★ 診断実行 (5段階評価の集計ロジック) ---
        document.getElementById('shindan-form').addEventListener('submit', function(event) {
            event.preventDefault(); 

            const formData = new FormData(event.target);
            const answers = Object.fromEntries(formData.entries());

            if (Object.keys(answers).length < questionData.length) {
                alert("すべての質問に回答してください。");
                return;
            }

            // --- 集計ロジック ---
            // 5: 強くそう思う (A+2)
            // 4: そう思う (A+1)
            // 3: どちらでもない (0)
            // 2: そう思わない (B+1)
            // 1: 強くそう思わない (B+2)
            const scores = { 
                axis1: { A: 0, B: 0 }, // L/F
                axis2: { A: 0, B: 0 }, // C/P
                axis3: { A: 0, B: 0 }, // I/O
                axis4: { A: 0, B: 0 }  // H/F
            };

            questionData.forEach(q => {
                const answer = answers[q.id]; // '1'～'5' の値
                const axis = q.axis;

                switch (answer) {
                    case '5': scores[axis].A += 2; break; // 強くそう思う
                    case '4': scores[axis].A += 1; break; // そう思う
                    case '3': break;                      // どちらでもない
                    case '2': scores[axis].B += 1; break; // そう思わない
                    case '1': scores[axis].B += 2; break; // 強くそう思わない
                }
            });

            // タイプの決定
            const type = [
                (scores.axis1.A > scores.axis1.B) ? 'L' : 'F',
                (scores.axis2.A > scores.axis2.B) ? 'C' : 'P',
                (scores.axis3.A > scores.axis3.B) ? 'I' : 'O',
                (scores.axis4.A > scores.axis4.B) ? 'H' : 'F'
            ].join('');

            // 結果の表示
            const result = resultData[type] || resultData["DEFAULT"];
            document.getElementById('result-type').textContent = type;
            document.getElementById('result-title').textContent = result.title;
            // ★変更★ 改行(\n)を <br> に変換してHTMLに挿入
            document.getElementById('result-description').innerHTML = result.description.replace(/\n/g, '<br>');
            document.getElementById('result').style.display = 'block';

            // --- ★変更★ シェアロジックの更新 ---
            const shareUrl = window.location.href; // このページのURL
            const hashTag = "接客タイプ診断"; 
            const shareText = `私の得意な接客タイプは【${result.title}（${type}）】でした！\nあなたも診断してみよう！\n#${hashTag}\n`;
            
            // X (Twitter)
            document.getElementById('share-x').href = `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(shareUrl)}`;
            // LINE
            document.getElementById('share-line').href = `https://line.me/R/msg/text/?${encodeURIComponent(shareText + shareUrl)}`;

            // 結果表示位置にスクロール
            document.getElementById('result').scrollIntoView({ behavior: 'smooth' });
        });
    </script>

</body>
</html>
